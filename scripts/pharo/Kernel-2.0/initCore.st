!ScriptLoader methodsFor: 'cleaning' stamp: 'PavelKrivanek 9/23/2010 10:30'!cleanUpAfterMorphicInitialization  "self new cleanUpForRelease"  Author fullName: 'Mr.Cleaner'. " DebuggerMethodMap withAllSubclassesDo: [ :each | each voidMapCache ]."" self cleanUpPackageOrganizer.  self cleanUpMethods." MCDataStream initialize.  GradientFillStyle initPixelRampCache.  FreeTypeCache clearCurrent.  ImageMorph classPool at: #DefaultForm put: (Form extent: 1 @ 1 depth: 1).  Behavior flushObsoleteSubclasses.  MethodChangeRecord allInstancesDo: [ :x | x noteNewMethod: nil ].  World cleanseOtherworldlySteppers.  Smalltalk organization removeEmptyCategories.  Browser initialize.  SystemBrowser removeObsolete.  AppRegistry removeObsolete.  FileServices removeObsolete.  MCFileBasedRepository flushAllCaches.  MCMethodDefinition shutDown.   MCDefinition clearInstances.  ExternalDropHandler resetRegisteredHandlers.  Undeclared removeUnreferencedKeys.  Smalltalk globals flushClassNameCache.  ScrollBar initializeImagesCache.  FreeTypeFontProvider current initialize.  NaturalLanguageTranslator classPool at: #AllKnownPhrases put: nil.  FreeTypeFontProvider current initialize." SystemNavigation default    allObjectsDo: [ :each |       (each respondsTo: #releaseCachedState)        ifTrue: [ each releaseCachedState ] ]." 3 timesRepeat: [     Smalltalk garbageCollect.    Symbol compactSymbolTable ].  HashedCollection rehashAll.    "Remove empty categories, which are not in MC packages, because MC does  not do this (this script does not make packages dirty)"  Smalltalk organization removeEmptyCategories.  Smalltalk    allClassesAndTraitsDo: [ :class |      [ :each |        each          removeEmptyCategories;          sortCategories ]            value: class organization;            value: class class organization ]." PackageOrganizer default packages    do: [ :each | each methods ifEmpty: [ PackageOrganizer default unregisterPackage: each ] ]    displayingProgress: 'Cleaning Packages'." Smalltalk organization sortCategories. ChangeSet removeChangeSetsNamedSuchThat: [ :each | true ].  ChangeSet resetCurrentToNewUnnamedChangeSet.  Smalltalk garbageCollect.  Author reset! !| dict dejavu prj world table mcRegistry repoGroup initializedClasses blacklistedClasses |"|dict|dict := Dictionary new.  dict at: #DejaVu put: (TextStyle named: 'Bitmap DejaVu Sans').  dict at: #DecimalProperty put: (Unicode classPool at: #DecimalProperty).  dict at: #GeneralCategory put: (Unicode classPool at: #GeneralCategory).  dict at: #GB2312Table put: (UCSTable classPool at: #GB2312Table).  dict at: #JISX0208Table put: (UCSTable classPool at: #JISX0208Table).  dict at: #KSX1001Table put: (UCSTable classPool at: #KSX1001Table).FLSerializer serialize: dict toFileNamed: 'morphicData.fuel'"["Initialize Fuel"FLLargeIdentityHashedCollection initialize.FLWellKnownObjectsCluster initialize.FileStream stdout nextPutAll: 'starting...'; lf.dict := FLMaterializer materializeFromFileNamed: 'morphicData.fuel'.FileStream stdout nextPutAll: 'dict loaded...'; lf.initializedClasses := Set new. blacklistedClasses := ((Smalltalk image kernelPackageNames   gather: [:p | SystemNavigation default allClassesInPackageNamed: p])   collect: [:p | p name]) asSet.blacklistedClasses add: #RPackageOrganizer.FileStream stdout nextPutAll: 'blacklist created...'; lf."#(#Behavior #ProcessorScheduler #SmalltalkImage #Delay #ByteString #ByteTextConverter #Categorizer #ChronologyConstants #Collection #CompiledMethod #Delay #DateAndTime #DefaultExternalDropHandler #EncodedCharSet #ExternalDropHandler #ExternalSemaphoreTable #Float #Halt #HashTableSizes #ISOLanguageDefinition #InstructionStream #Integer#LanguageEnvironment #Locale #Object #OSPlatform #ProcessSpecificVariable #SetElement #String #Symbol #EventSensorConstants #WeakFinalizationList #WeakArray #WeakAnnouncementSubscription #WideSymbol #DefaultCommandLineHandler #RxMatcher #RxParser #RxsPredicate #AsyncFile #FileLocator #FileHandle #DiskStore #FileStream #MultiByteFileStream #FLWellKnownObjectsCluster #FLLargeIdentityHashedCollection) do: [:each | (Smalltalk globals at: each) initialize. initializedClasses add: each.].FileStream stdout nextPutAll: 'basic classes initialized...'; lf.#(RGFactory InternetConfiguration NetNameResolver Socket Base64MimeConverter MIMEType UUIDGenerator URI HTTPSocket PackageInfo FileServices SystemAnnouncer MCCacheRepository MCDirtyPackageInfo MCEmptyPackageInfo MCMethodDefinition MCMockASubclass MCMockClassA MCPackageManager MCVersionReader MCWorkingCopy ZnByteEncoder ZnConstants ZnMimeType ZnNetworkingUtils ZnServer ZnSingleThreadedServer) do: [:c | (Smalltalk globals at: c) initialize.]."dejavu := dict at: #DejaVu. TextConstants TextSharedInformation at: #DefaultTextStyle put: dejavu.TextConstants TextSharedInformation at: #'Bitmap DejaVu Sans' put: dejavu.TextConstants TextSharedInformation at: #DefaultMultiStyle put: dejavu.TextConstants TextSharedInformation at: #DefaultFixedTextStyle put: dejavu.#(StrikeFontFixer TextStyle) do: [:each | (Smalltalk globals at: each) initialize. initializedClasses add: each.].FileStream stdout nextPutAll: 'loading tables...' asString; lf.Unicode classPool at: #DecimalProperty put: (dict at: #DecimalProperty).Unicode classPool at: #GeneralCategory put: (dict at: #GeneralCategory).UCSTable classPool at: #GB2312Table put: (dict at: #GB2312Table).UCSTable classPool at: #JISX0208Table put: (dict at: #JISX0208Table).UCSTable classPool at: #KSX1001Table put: (dict at: #KSX1001Table).FileStream stdout nextPutAll: 'finished' asString; lf.#(ProgressBarMorph BalloonBezierSimulation BalloonEngineConstants BalloonEngine BrowserCornerRounder CPUWatcher Debugger DigitalSignatureAlgorithm DummySoundSystem FileContentsBrowserFileList FixUnderscores FreeTypeCacheConstants FreeTypeCache FreeTypeSettings FreeTypeSubPixelAntiAliasedGlyphRenderer FT2Constants FT2Handle GIFReadWriterHaloMorph HandMorph ChangeList ChangeSorter CharacterScanner ImageMorph JPEGHuffmanTableJPEGReadStream JPEGReadWriter LogicalFont LongTestCase MailAddressTokenizer MailCompositionMczInstaller MD5NonPrimitive MenuItemMorph MenuMorph Morph MultiCharacterScannerPNGReadWriter PrettyPrinting ProcessBrowser RealEstateAgent RxMatcher RxParser RxsPredicateScriptLoader ScrollBar SecureHashAlgorithm SHA1 ShortIntegerArray ShortRunArray SimpleEditorStrikeFontFixer SystemProgressMorph SystemWindow TestCase TextContainer TextDiffBuilderThemeIcons ThumbnailMorph TransferMorph UITheme VistaryThemeIcons WorldState ZnByteEncoderZnConstants ZnMimeType ZnNetworkingUtils ZnServer ZnSingleThreadedServer RGFactory) do: [:each | (Smalltalk globals at: each) initialize. initializedClasses add: each.].Cursor initTarget.BalloonMorph setBalloonColorTo: Color yellow.world := PasteUpMorph new.world instVarNamed: #worldState put: WorldState new.world world addHand: HandMorph new.world activeHand.Smalltalk at: #World put: world.Smalltalk at: #ActiveWorld put: world.Smalltalk at: #ActiveHand put: world activeHand.Smalltalk at: #ActiveEvent put: nil.world viewBox: Display boundingBox.Sensor flushAllButDandDEvents.world world handsDo: [:h | h initForEvents].world borderWidth: 0.MorphicUIManager new spawnNewProcess.SystemWindow noteTopWindowIn: world.Display newDepth: 32.world displayWorldSafely.UIManager default: MorphicUIManager new.world displayWorldSafely.UIManager default uiProcess resume."MorphicTextEditor register: PluggableTextMorph."PharoTheme beCurrent.TestRunnerBrowser register: TestRunner.(world windowsSatisfying: [:w | w model canDiscardEdits]) do: [:w | w delete].ScriptLoader new cleanUpAfterMorphicInitialization.Display newDepth: 32.(world instVarNamed: #worldState) canvas: nil.GraphicFontSettings setFontsToStyleNamed: #small."CombinedChar loadCompositionMapping."(Smalltalk at: #ActiveHand) instVarNamed: #targetOffset put: 0@0."LogoImageMorph installDesktopLogo."PolymorphSystemSettings showDesktopLogo: false.PolymorphSystemSettings showDesktopLogo: true.PolymorphSystemSettings desktopColor: Color white.Smalltalk cleanOutUndeclared.(((Smalltalk allClasses select: [:c | c class includesSelector: #initialize] thenCollect: [:c | c name])   copyWithoutAll: initializedClasses) copyWithoutAll: blacklistedClasses)    do: [:each |       (Smalltalk globals at: each) initialize]."mcRegistry := dict at: #MCRegistry. "repoGroup := MCRepositoryGroup new.repoGroup addRepository: (MCHttpRepository  location: 'http://ss3.gemstone.com/ss/Pharo20'  user: ''  password: '').  repoGroup addRepository: (MCHttpRepository  location: 'http://ss3.gemstone.com/ss/PharoInbox'  user: ''  password: '')."mcRegistry keysAndValuesDo: [:package :oldWorkingCopy |  | workingCopy |  PackageInfo registerPackageName: package name.  workingCopy := MCWorkingCopy forPackage: (MCPackage new name: package name).   workingCopy instVarNamed: #ancestry put: oldWorkingCopy ancestry.  workingCopy instVarNamed: #repositoryGroup put: repoGroup].""RPackageOrganizer fillUp."]   ifError: [:e |    | rep |    rep := FileStream forceNewFileNamed: 'PharoDebug.log'.    rep nextPutAll: 'PharoKernel shrinking report'; cr.    rep nextPutAll: 'Error:'; cr.    rep nextPutAll: e asString; cr.    rep nextPutAll: thisContext stack size asString.    thisContext stack copy withIndexDo: [:stck :i |    [ rep nextPutAll: i asString; space; nextPutAll: stck asString; cr] ifError: []].    rep close.     Smalltalk exitFailure ].SmalltalkImage current snapshot: true andQuit: false.SmalltalkImage current snapshot: true andQuit: true.UIManager default restoreDisplay.